# Routing & Mapping Documentation
## وثائق التوجيه والربط

---

## 1. أنواع المزودين (Provider Types)

### 1.1 المزودين الخارجيين (External Providers)

#### ZDK
- **العملة:** دولار أمريكي (USD)
- **التحويل:** لا يحتاج تحويل عملة (السعر بالدولار مباشرة)
- **الأسعار:** متغيرة (يتم جلبها من API)

#### ZNET
- **العملة:** ليرة تركية (TRY)
- **التحويل:** يجب تحويل السعر من ليرة → دولار
- **الأسعار:** متغيرة (يتم جلبها من API)
- **مثال:** باقة سعرها ₺45.00 → يتم تحويلها لدولار حسب `rate_to_usd` → تظهر في حقل التكلفة للمستأجر

### 1.2 المزودين الداخليين (Internal Providers - Intermediaries)

**المفهوم:**
- أي مستأجر في النظام يمكن أن يكون مزود داخلي لمستأجر آخر
- **مثال:** "الشام" يستخدم "شام تيك" كمزود

**الآلية:**
1. "الشام" ينشئ **حساب وكيل** في نظام "شام تيك"
2. هذا الوكيل **لا يُستخدم يدوياً** للشحن
3. يُضاف كـ **مزود داخلي** في نظام "الشام"
4. عند توجيه طلب، يتم:
   - فتح حساب الوكيل تلقائياً
   - إنشاء الطلب في نظام "شام تيك"
   - خصم المبلغ من رصيد الوكيل
   - "شام تيك" يعالج الطلب (يدوياً أو بإعادة التوجيه)

**المحفظة والشحن:**
- المستأجر **ليس له محفظة** في نظام المزود
- يستخدم **محفظة الوكيل** التي أنشأها
- يتواصل مع المزود خارج النظام لشحن الرصيد
- يظهر له وسائل الدفع التي أضافها المزود
- المزود يوافق على الشحن → الرصيد يزيد

### 1.3 المخزون (Stock/Inventory)

**المفهوم:**
- كل مستأجر لديه مخزون للأكواد الرقمية
- مختلف الأنواع (iTunes، Google Play، بطاقات ألعاب، إلخ)

**الآلية:**
- TODO: سيتم مناقشتها لاحقاً

---

## 2. نظام Product & Package

### 2.1 الهيكلية

**المنتج (Product):**
- ليس له سعر
- فقط: اسم، صورة، وصف، تصنيف

**الباقة (Package):**
- تنتمي لمنتج
- لها سعر محدد
- **مثال:**
  ```
  المنتج: PUBG Mobile
    ├─ باقة: PUBG 60 UC → $2.00
    ├─ باقة: PUBG 325 UC → $8.00
    └─ باقة: PUBG 660 UC → $15.00
  ```

### 2.2 نظام الربط لدى المزودين

**كل مزود خارجي له نظام ترقيم خاص:**

```
Product ID + Package Link Number = المفتاح الفريد

مثال ZDK:
- Product ID: 22 (PUBG)
- Package Link: 60 (60 UC)
- المفتاح: (22, 60)

مثال ZNET:
- Product ID: 15 (PUBG) ← رقم مختلف عن ZDK
- Package Link: 60 (60 UC)
- المفتاح: (15, 60)
```

**ملاحظة مهمة:**
- رقم الربط (Package Link) يمكن أن يتكرر في منتجات مختلفة
- مثال: Free Fire 60 Diamonds → (35, 60) ✅

### 2.3 الحصول على بيانات المزود

**كل مزود خارجي يوفر:**
- API endpoint لجلب قائمة المنتجات والباقات
- البيانات بصيغة JSON
- تحتوي على:
  - Product ID
  - Product Name
  - Package Link Number
  - Package Name
  - السعر (بعملة المزود)
  - التوفر (in_stock)

---

## 3. ربط الباقات (Package Mapping)

### 3.1 واجهة الربط

**عندما المستأجر يضغط زر "ربط" بجانب مزود:**

1. النظام يرسل API request للمزود
2. يجلب آخر تحديث للباقات والأسعار
3. يعرض جدول الربط:

```
┌─────────────────────┬────────────────────────────────┐
│ باقاتي             │ باقات ZNET                    │
├─────────────────────┼────────────────────────────────┤
│ PUBG 60 UC         │ [قائمة منسدلة ▼]              │
│ سعري: $2.00        │ ☑ PUBG 60 (₺45.00 = $1.20)   │
│                     │   PUBG 325 (₺230.00 = $6.13) │
│                     │   Free Fire 60 (₺40.00)       │
├─────────────────────┼────────────────────────────────┤
│ PUBG 325 UC        │ [قائمة منسدلة ▼]              │
│ سعري: $8.00        │   PUBG 60 (₺45.00)            │
│                     │ ☑ PUBG 325 (₺230.00 = $6.13) │
└─────────────────────┴────────────────────────────────┘
                                             [حفظ الربط]
```

### 3.2 تحديث الأسعار

**استراتيجية التحديث:**
1. ✅ عند الضغط على زر "ربط" → جلب بيانات جديدة من API
2. ✅ تحديث دوري كل 6 ساعات (Celery Worker)
3. ✅ حفظ الأسعار في قاعدة البيانات
4. ❌ لا يوجد زر تحديث يدوي منفصل

**عند تغيير السعر:**
```
┌────────────────────────────────────────┐
│ 🔔 لديك 3 تحديثات في الأسعار        │ [عرض التغييرات]
└────────────────────────────────────────┘

عند الضغط:
┌──────────────┬─────────┬──────────────┬──────────────┐
│ الباقة      │ المزود │ السعر القديم │ السعر الجديد │
├──────────────┼─────────┼──────────────┼──────────────┤
│ PUBG 60 UC   │ ZNET   │ ₺45.00      │ ₺50.00 ⬆️   │
│ FF 100 Dia   │ ZDK    │ $2.50       │ $2.30 ⬇️    │
└──────────────┴─────────┴──────────────┴──────────────┘
                                  [تم الاطلاع ✓]
```

**بعد الضغط على "تم الاطلاع":**
- الإشعار يختفي ✅
- السعر الجديد يُطبق تلقائياً

---

## 4. سلسلة التوجيه (Routing Chain)

### 4.1 الحد الأقصى للتوجيه

**الحد الأقصى: 5 توجيهات**

```
Level 1: وكيل "الشام" → ينشئ طلب
  ↓
Level 2: "الشام" → يوجه لـ "شام تيك"
  ↓
Level 3: "شام تيك" → يوجه لـ "الأمل"
  ↓
Level 4: "الأمل" → يوجه لـ "النور"
  ↓
Level 5: "النور" → يوجه لـ "الفجر"
  ↓
Level 6: "الفجر" → لازم يشحن يدوياً أو يرسل لمزود خارجي ✅
```

### 4.2 تتبع السلسلة

**يجب حفظ:**
- الطلب الأصلي (Original Order)
- من أين جاء (Parent Order ID)
- إلى أين ذهب (Child Order ID)
- مستوى التوجيه الحالي (Routing Level: 1-5)

**مثال في قاعدة البيانات:**
```
orders table:
┌─────────┬──────────────┬─────────────────┬────────────────┬───────────────┐
│ uuid    │ tenant_id    │ parent_order_id │ child_order_id │ routing_level │
├─────────┼──────────────┼─────────────────┼────────────────┼───────────────┤
│ abc123  │ الشام (10)   │ NULL            │ def456         │ 1             │
│ def456  │ شام تيك (20) │ abc123          │ ghi789         │ 2             │
│ ghi789  │ الأمل (30)   │ def456          │ NULL           │ 3             │
└─────────┴──────────────┴─────────────────┴────────────────┴───────────────┘
```

### 4.3 تحديث الحالة التلقائي

**عندما آخر مزود في السلسلة يوافق على الطلب:**

```
"الأمل" يشحن الطلب → (status: completed) ✅
  ↓ تلقائياً
"شام تيك" → (status: completed) ✅
  ↓ تلقائياً
"الشام" → (status: completed) ✅
  ↓ تلقائياً
وكيل "الشام" → (status: completed) ✅
```

**الآلية:**
1. عند تغيير حالة الطلب → trigger
2. البحث عن `parent_order_id`
3. تحديث حالة الـ parent
4. تكرار العملية حتى الوصول للطلب الأصلي

---

## 5. حساب التكلفة والربح

### 5.1 سعر التكلفة في التوجيه الداخلي

**القاعدة:**
- عندما يوجه المستأجر طلب لوسيط داخلي
- التكلفة = سعر الباقة عند الوسيط (للوكلاء العاديين)

**مثال:**

```
"شام تيك" عنده باقة "PUBG 60 UC" → سعرها $1.50

"الشام" أنشأ وكيل في نظام "شام تيك"
  ↓
الوكيل يشتري بنفس السعر $1.50

التدفق المالي:
┌──────────────────────────────────────────┐
│ وكيل "الشام" يدفع: $2.00               │
│   ↓ (سعر الشام)                         │
│ "الشام" يوجه → وكيل في "شام تيك"       │
│   ↓ يُخصم من رصيد الوكيل: $1.50        │
│ تكلفة الشام: $1.50                      │
│ ربح الشام: $2.00 - $1.50 = $0.50 ✅    │
└──────────────────────────────────────────┘
```

### 5.2 سعر التكلفة من المزودين الخارجيين

**ZDK (دولار):**
```
الباقة في ZDK: $1.00
  ↓ (لا يوجد تحويل)
التكلفة المحفوظة: $1.00
```

**ZNET (ليرة تركية):**
```
الباقة في ZNET: ₺45.00
  ↓ (تحويل)
rate_to_usd = 30.000 (1 USD = 30 TRY)
  ↓
التكلفة بالدولار = 45.00 / 30.000 = $1.50
  ↓
التكلفة المحفوظة: $1.50
```

---

## 6. التوجيه التلقائي (Auto-Routing)

### 6.1 قسم التوجيه

**المستأجر يستطيع إعداد توجيه تلقائي للطلبات:**

```
منتج: PUBG 60 UC

الأولويات:
  Priority 1: ZNET (إذا متوفر)
  Priority 2: شام تيك (وسيط داخلي)
  Priority 3: المخزون (stock)
  Priority 4: ZDK
```

### 6.2 شروط "المتوفر"

**للمزود الخارجي:**
- API يرد `in_stock = true`
- أو `stock_quantity > 0`

**للوسيط الداخلي:**
- `balance_usd >= package_price`
- الوكيل `status = 'active'`

**للمخزون:**
- `stock_quantity > 0`
- الكود غير مستخدم

### 6.3 آلية التوجيه التلقائي

```
1. يأتي طلب من وكيل
   ↓
2. النظام يفحص الأولويات:
   ↓
3. Priority 1 (ZNET):
   - هل متوفر؟ نعم ✅ → إرسال الطلب
   - هل متوفر؟ لا ❌ → الانتقال للتالي
   ↓
4. Priority 2 (شام تيك):
   - هل الرصيد كافي؟ نعم ✅ → توجيه الطلب
   - هل الرصيد كافي؟ لا ❌ → الانتقال للتالي
   ↓
5. Priority 3 (المخزون):
   - هل يوجد كود متاح؟ نعم ✅ → سحب الكود
   - هل يوجد كود متاح؟ لا ❌ → الانتقال للتالي
   ↓
6. Priority 4 (ZDK):
   - آخر خيار → إرسال الطلب
   ↓
7. إذا فشلت كل الخيارات:
   - حالة الطلب: failed
   - إشعار للمستأجر
```

---

## 7. نقاط مهمة للتطوير

### 7.1 قاعدة البيانات

**جداول مطلوبة:**
- `products` (المنتجات)
- `packages` (الباقات)
- `providers` (المزودين)
- `package_provider_mappings` (ربط الباقات بالمزودين)
- `orders` (الطلبات)
- `routing_rules` (قواعد التوجيه التلقائي)
- `price_change_notifications` (إشعارات تغيير الأسعار)

### 7.2 Celery Tasks

**مهام مطلوبة:**
1. تحديث أسعار المزودين الخارجيين (كل 6 ساعات)
2. مراقبة توفر المنتجات
3. إشعارات تغيير الأسعار
4. تحديث حالات الطلبات في السلسلة

### 7.3 API Endpoints

**للمستأجر:**
- `POST /api/tenant/providers/{provider_id}/sync` - جلب بيانات المزود
- `GET /api/tenant/providers/{provider_id}/packages` - قائمة باقات المزود
- `POST /api/tenant/packages/{package_id}/map` - ربط باقة بمزود
- `GET /api/tenant/price-changes` - إشعارات تغيير الأسعار
- `POST /api/tenant/routing-rules` - إعداد قواعد التوجيه
- `POST /api/tenant/orders/{order_id}/forward` - توجيه طلب يدوياً

---

## 8. المخزون (Stock Management)

### 8.1 المفهوم

**المخزون = أكواد رقمية جاهزة:**
- المستأجر يشتري أكواد من مصادر خارجية
- يضيفها في النظام
- عند الطلب → يُسحب كود ويُعطى للوكيل

### 8.2 تفعيل المخزون للمنتج

**في قسم المنتجات → عند إضافة/تعديل منتج:**

```
┌────────────────────────────────────┐
│ اسم المنتج: PUBG Mobile          │
│ الوصف: بطاقات شحن ببجي موبايل    │
│ الصورة: [رفع صورة]               │
│ التصنيف: ألعاب                   │
│                                    │
│ ☑ يدعم الأكواد الرقمية           │ ← checkbox
│   (تفعيل هذا الخيار يُظهر        │
│    المنتج في قسم المخزون)        │
└────────────────────────────────────┘
```

**ملاحظة:**
- فقط المنتجات المُفعّل لها `☑ يدعم الأكواد الرقمية` تظهر في قسم المخزون
- المنتج العادي (بدون تفعيل) = يُشحن عبر مزود خارجي أو وسيط فقط

### 8.3 واجهة المخزون

**قسم مستقل: "مخزون الأكواد"**

```
┌─────────────────────────────────────────────┐
│ 📦 مخزون الأكواد                           │
├─────────────────────────────────────────────┤
│ 🎮 PUBG Mobile (3 باقات)                   │ ← يضغط للتوسيع
│   ├─ PUBG 60 UC                            │
│   │  ├─ متاح: 15 كود ✅                    │
│   │  └─ [إضافة أكواد]                      │
│   │                                         │
│   ├─ PUBG 325 UC                           │
│   │  ├─ متاح: 0 كود ⚠️                     │
│   │  └─ [إضافة أكواد]                      │
│   │                                         │
│   └─ PUBG 660 UC                           │
│      ├─ متاح: 8 كود ✅                     │
│      └─ [إضافة أكواد]                      │
│                                             │
├─────────────────────────────────────────────┤
│ 🎵 iTunes (2 باقات)                        │
│   ├─ iTunes $10                            │
│   │  ├─ متاح: 50 كود ✅                    │
│   │  └─ [إضافة أكواد]                      │
│   │                                         │
│   └─ iTunes $25                            │
│      ├─ متاح: 20 كود ✅                    │
│      └─ [إضافة أكواد]                      │
└─────────────────────────────────────────────┘
```

### 8.4 إضافة الأكواد

**عند الضغط على [إضافة أكواد] لباقة معينة:**

```
┌─────────────────────────────────────────┐
│ إضافة أكواد لـ PUBG 60 UC              │
├─────────────────────────────────────────┤
│ الصق الأكواد (كل كود في سطر):         │
│ ┌─────────────────────────────────────┐ │
│ │ ABC123XYZ456                        │ │
│ │ DEF789UVW012                        │ │
│ │ GHI345RST678                        │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ عدد الأكواد: 3                         │
│                                         │
│          [إلغاء]    [حفظ الأكواد]      │
└─────────────────────────────────────────┘
```

**الآلية:**
1. المستأجر يلصق الأكواد (كل كود في سطر منفصل)
2. النظام يُنظف البيانات (إزالة فراغات، أسطر فارغة)
3. يفحص التكرار (لو الكود موجود مسبقاً → تنبيه)
4. يحفظ الأكواد بحالة `status = 'available'`

### 8.5 سحب الكود عند الطلب

**عندما يُوجّه طلب للمخزون:**

```
1. الوكيل ينشئ طلب "PUBG 60 UC"
   ↓
2. النظام يفحص قواعد التوجيه → Priority: المخزون
   ↓
3. البحث في جدول المخزون:
   - package_id = PUBG 60 UC
   - status = 'available'
   - LIMIT 1
   ↓
4. سحب الكود:
   - الكود: "ABC123XYZ456"
   - تحديث: status = 'used'
   - ربط: order_id = الطلب الحالي
   ↓
5. وضع الكود في ملاحظة الطلب:
   - order.notes = "الكود: ABC123XYZ456"
   - order.status = 'completed' ✅
   ↓
6. الوكيل يرى في تفاصيل الطلب:
   ┌──────────────────────────────┐
   │ 🎮 PUBG 60 UC               │
   │ الحالة: مكتمل ✅            │
   │                              │
   │ 📝 الكود:                   │
   │ ABC123XYZ456                │
   │ [نسخ الكود 📋]              │
   └──────────────────────────────┘
```

### 8.6 حالات الأكواد

```
available   → متاح للاستخدام
used        → مستخدم (مرتبط بطلب)
expired     → منتهي الصلاحية (إن وجد)
reserved    → محجوز مؤقتاً (أثناء معالجة الطلب)
```

### 8.7 ميزات مستقبلية (TODO)

**Phase 2:**
- ✅ رفع ملف Excel/CSV (بدلاً من اللصق اليدوي)
- ✅ تصدير الأكواد المستخدمة/المتاحة
- ✅ تاريخ انتهاء صلاحية للأكواد
- ✅ تقارير المخزون (كم كود استُخدم، كم متبقي)
- ✅ إشعار عند نفاد المخزون (stock_quantity < 5)
- ✅ استيراد دفعات كبيرة (background job)

**مثال رفع ملف CSV:**
```csv
code,expiry_date
ABC123XYZ456,2025-12-31
DEF789UVW012,2025-12-31
GHI345RST678,2026-01-15
```

### 8.8 هيكل قاعدة البيانات (مبدئي)

```sql
Table stock_codes {
  id int [pk, increment]
  uuid varchar [unique, not null]
  package_id int [ref: > packages.id, not null]
  code varchar [unique, not null]  // الكود الفعلي
  status varchar [default: 'available']  // available, used, expired, reserved
  order_id int [ref: > orders.id, null]  // الطلب الذي استخدم الكود
  expiry_date date [null]  // تاريخ انتهاء الصلاحية (اختياري)
  added_by int [ref: > tenants.id, not null]
  used_at timestamp [null]
  created_at timestamp [default: `now()`]
  
  indexes {
    (package_id, status)
    (status, expiry_date)
  }
}
```

---

## 9. نقاط مهمة للتطوير (محدّثة)

### 9.1 قاعدة البيانات

**جداول مطلوبة:**
- `products` (المنتجات)
- `packages` (الباقات)
- `providers` (المزودين)
- `package_provider_mappings` (ربط الباقات بالمزودين)
- `orders` (الطلبات)
- `routing_rules` (قواعد التوجيه التلقائي)
- `price_change_notifications` (إشعارات تغيير الأسعار)
- `stock_codes` (مخزون الأكواد الرقمية) ← جديد

### 9.2 Celery Tasks

**مهام مطلوبة:**
1. تحديث أسعار المزودين الخارجيين (كل 6 ساعات)
2. مراقبة توفر المنتجات
3. إشعارات تغيير الأسعار
4. تحديث حالات الطلبات في السلسلة
5. **فحص انتهاء صلاحية الأكواد (يومياً)** ← جديد
6. **إشعارات نفاد المخزون** ← جديد

### 9.3 API Endpoints

**للمستأجر:**
- `POST /api/tenant/providers/{provider_id}/sync` - جلب بيانات المزود
- `GET /api/tenant/providers/{provider_id}/packages` - قائمة باقات المزود
- `POST /api/tenant/packages/{package_id}/map` - ربط باقة بمزود
- `GET /api/tenant/price-changes` - إشعارات تغيير الأسعار
- `POST /api/tenant/routing-rules` - إعداد قواعد التوجيه
- `POST /api/tenant/orders/{order_id}/forward` - توجيه طلب يدوياً
- **`GET /api/tenant/stock` - عرض المخزون** ← جديد
- **`POST /api/tenant/stock/packages/{package_id}/codes` - إضافة أكواد** ← جديد
- **`GET /api/tenant/stock/packages/{package_id}/codes` - عرض أكواد باقة** ← جديد
- **`GET /api/tenant/stock/reports` - تقارير المخزون** ← جديد
