## Tech Stack (لغات ومكتبات المشروع)

### Backend:
- **Framework:** Django (Python)
- **API:** Django REST Framework (DRF) + Serializers
- **Cache:** Redis
- **Task Queue:** Celery
  - **Worker 1:** متابعة طلبات المزودين الخارجيين (webhooks, API calls, status updates)
  - **Worker 2:** مهام ثانوية (emails, SMS, reports, cleanup)
- **Database:** PostgreSQL
- **Admin Panel:** لا نستخدم Django Admin - نصمم لوحة تحكم مخصصة

### Backend Structure (3 Django Apps):
```
backend/
├── core/              # مشترك: models, utils, permissions, base classes
├── super_admin/       # إدارة المنصة والمستأجرين
├── tenant/            # إدارة المتاجر والوكلاء والمنتجات
└── agent/             # طلبات الوكلاء وإدارة الرصيد
```

### Authentication:
- **JWT Token** موحّد لكل الأدوار
- Endpoints منفصلة لكل دور:
  - `/api/super-admin/auth/login`
  - `/api/tenant/auth/login`
  - `/api/agent/auth/login`
- الـ Token يحمل: `role`, `user_id`, `tenant_id` (للـ tenant/agent)

---

### Frontend:
- **Framework:** Next.js (React)
- **Structure:** 3 أقسام منفصلة تمامًا (layouts مختلفة لكل دور)

```
app/
├── (super-admin)/
│   ├── layout.tsx          # تصميم خاص بالـ Super Admin
│   ├── dashboard/
│   ├── tenants/
│   └── settings/
│
├── (tenant)/
│   ├── layout.tsx          # تصميم خاص بالمستأجر
│   ├── dashboard/
│   ├── products/
│   ├── agents/
│   └── orders/
│
└── (agent)/
    ├── layout.tsx          # تصميم خاص بالوكيل
    ├── dashboard/
    ├── new-order/
    └── history/
```

### Frontend Routing:
- **Super Admin:** `admin.wtn.com`
- **Tenant:** `{tenant-code}.wtn.com` (مثال: `store123.wtn.com`)
- **Agent:** `{tenant-code}.wtn.com/agent`

### Shared Resources:
- `components/shared/` - عناصر مشتركة (buttons, inputs, modals)
- `utils/`, `hooks/`, `lib/api-client/` - مشتركة بين الأدوار
- Design tokens (colors, spacing, typography) - موحّدة للاتساق

<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->

## UUID Pattern


**الصيغة:** `wtn-{role}-{unique_6_chars}`

حيث:
- `wtn`: بادئة المشروع (ثابتة)
- `{role}`: نوع الدور/الجدول
- `{unique_6_chars}`: 6 أحرف lowercase alphanumeric فريدة (a-z0-9)

### الأنماط لكل جدول:

**1. Super Admins**
- Pattern: `^wtn-admin-[a-z0-9]{6}$`
- Example: `wtn-admin-x7k2m9`

**2. Tenants**
- Pattern: `^wtn-tenant-[a-z0-9]{6}$`
- Example: `wtn-tenant-a1b2c3`

**3. Agents**
- Pattern: `^wtn-agent-[a-z0-9]{6}$`
- Example: `wtn-agent-q5w8r2`

**4. Tenant Currencies**
- Pattern: `^wtn-currency-[a-z0-9]{6}$`
- Example: `wtn-currency-m3n7p1`

### ملاحظات للبرمجة:
- توليد الـ 6 أحرف: استخدم random alphanumeric generator
- التحقق من الفرادة: CHECK constraint في DB قبل الإدخال
- كل جدول: عمود `uuid` varchar(20) NOT NULL UNIQUE
- الطول الثابت: 20 حرف (`wtn-` = 4 + role + `-` + 6 chars)

<!-- ------------------------------------------------- -->

## Tenant Code Pattern

صيغة: أحرف لاتينية كبيرة + أرقام فقط، طول 3–12 حرف

- Pattern: `^[A-Z0-9]{3,12}$`
- أمثلة صحيحة: `ACME`, `ALPHA1`, `STORE42`, `TEN123ABC`
- فريد على مستوى المنصة (UNIQUE constraint)
- يُستخدم كمعرّف قصير سهل القراءة والمشاركة (مثل الـ subdomain)

<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->

## سياسة الأرقام العشرية (Decimal Policy)

**التخزين في قاعدة البيانات:**
- كل الأرقام المالية والعملات: `DECIMAL(18,3)` (3 خانات عشرية)
- ينطبق على: `balance_local`, `rate_to_usd`, `amount`, `price`, إلخ

**العرض في الواجهات (API/Frontend):**
- إذا الخانة الثالثة = `0` → اعرض خانتين فقط
- احتفظ بخانتين كحد أدنى دائمًا

**أمثلة:**
```
DB: 25.225  →  Display: 25.225
DB: 25.000  →  Display: 25.00
DB: 25.100  →  Display: 25.10
DB: 0.005   →  Display: 0.005
DB: 100.500 →  Display: 100.50
```

**ملاحظات للبرمجة:**
- دالة التنسيق: احذف الأصفار الزائدة من اليمين، لكن أبقِ خانتين كحد أدنى
- مثال (JavaScript): `parseFloat(value.toFixed(3)).toFixed(2)`
- مثال (Python): `f"{value:.3f}".rstrip('0').rstrip('.') if value % 0.01 else f"{value:.2f}"`

<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->

## نموذج العمل والأدوار (Business Model)

### نظرة عامة:
منصة **وطن (WTN)** هي نظام SaaS متعدد المستأجرين (Multi-tenant) لبيع وإدارة متاجر الشحن الرقمي.

---

### الأدوار الثلاثة:

#### 1. Super Admin (المطور - أنت وأخوك)
**المسؤوليات:**
- برمجة وتطوير المنصة
- إنشاء Tenants جدد (مستأجرين)
- تخصيص subdomain لكل مستأجر
- مراقبة الأخطاء والسيرفرات
- صيانة النظام

**ما لا يفعله:**
- لا يتدخل في عمل المستأجرين بعد التسليم
- لا يدير المنتجات أو الطلبات

**الدخول:** `admin.wtn.com`

---

#### 2. Tenant (المستأجر - صاحب المتجر)
**من هو:**
- عميل اشترى **نسخة متجر إلكتروني كامل** منك
- يملك subdomain خاص: مثل `mohammadstore.wtn.com`

**المسؤوليات:**
- إدارة المنتجات (شحن ألعاب، بطاقات رقمية، رصيد تطبيقات، أكواد...)
- تحديد الأسعار والعملات المدعومة
- إضافة وإدارة الوكلاء (Agents = أصحاب المحلات)
- ربط حسابه مع المزودين الخارجيين (APIs)
- شحن رصيد للوكلاء
- متابعة المبيعات والأرباح والإحصائيات

**أمثلة منتجات:**
- شحن PUBG Mobile
- بطاقات iTunes/Google Play
- رصيد موبايلي/stc
- اشتراكات Netflix/Spotify

**الدخول:** `{tenant-code}.wtn.com`

---

#### 3. Agent (الوكيل - صاحب محل)
**من هو:**
- صاحب محل صغير في السوق
- يعمل لصالح Tenant معين (مثل متجر محمد)

**العمل اليومي:**
1. زبون يدخل المحل ويطلب: "شحن 100 ريال PUBG"
2. الوكيل يدخل النظام (عبر متصفح أو تطبيق موبايل)
3. يختار المنتج ويدخل بيانات الزبون (ID, رقم الحساب...)
4. يرسل الطلب
5. **Celery Worker** يوجه الطلب للمزود الخارجي
6. يستلم الكود/الشحن خلال ثواني
7. يعطيه للزبون ويحصّل المبلغ نقدًا

**نظام الرصيد:**
- المستأجر (Tenant) يشحن رصيد مسبق للوكيل
- كل طلب ينقص من رصيد الوكيل تلقائيًا
- الوكيل يستطيع رؤية رصيده الحالي

**الدخول:** `{tenant-code}.wtn.com/agent`

---

### السيناريو الكامل (مثال):

1. **Super Admin** ينشئ Tenant جديد: "محمد" → subdomain: `mohammadstore.wtn.com`
2. **محمد (Tenant)** يسجل دخول:
   - يضيف منتجات (شحن ألعاب، بطاقات)
   - يضيف 20 وكيل (علي، أحمد، فاطمة...)
   - يشحن لكل وكيل رصيد (مثلاً: 5000 ريال)
3. **علي (Agent)** يسجل دخول من محله:
   - زبون يطلب شحن PUBG بـ 50 ريال
   - علي يدخل الطلب → **Celery Worker** يرسل للمزود الخارجي
   - المزود يرجع الكود خلال 3 ثواني
   - علي يعطي الكود للزبون
   - رصيد علي ينقص: 5000 - 50 = 4950 ريال
4. **محمد (Tenant)** يشوف لوحة التحكم:
   - "علي باع اليوم 50 طلب، الربح: 500 ريال"
   - "إجمالي المبيعات: 10,000 ريال"

---

### ملاحظات مهمة:
- كل Tenant معزول تمامًا (لا يرى بيانات Tenants آخرين)
- الوكلاء يعملون فقط ضمن Tenant واحد (لا يستطيعون التنقل بين المتاجر)
- Super Admin لا يتدخل في العمليات اليومية

<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->

## سياسة العملات (Currency Policy)

### العملة الأساسية للنظام:
- **الدولار الأمريكي ($) فقط**
- كل الأرصدة والمبالغ تُخزن في قاعدة البيانات **بالدولار حصرًا**
- **لا نستخدم** أي تسميات مثل: "USD", "US Dollar", "دولار أمريكي"
- **نستخدم** فقط الرمز: `$`

---

### العملات حسب الدور:

#### 1. Super Admin
- يتعامل بالدولار ($) حصرًا
- كل الأرصدة والتقارير والإحصائيات بالدولار
- لا يوجد عملات أخرى في لوحة التحكم

#### 2. Tenant (المستأجر)
- رصيده **بالدولار ($) حصرًا**
- يشتري/يبيع/يحاسب بالدولار
- لوحة التحكم تعرض كل شيء بالدولار

**إدارة العملات للوكلاء:**
- المستأجر يذهب لقسم **"العملات"** في لوحة التحكم
- يضيف عملات ليستخدمها الوكلاء (ريال سعودي، ليرة تركية، يورو...)
- **حتى الدولار ($) يجب إضافته** إذا أراد الوكلاء العمل بالدولار
- لكل عملة يحدد **سعر الصرف مقابل الدولار**

**أمثلة:**
```
العملة: دولار أمريكي ($)
سعر الصرف: 1$ = 1.00$

العملة: ريال سعودي (ر.س)
سعر الصرف: 1$ = 3.75 ر.س

العملة: ليرة تركية (₺)
سعر الصرف: 1$ = 32.50 ₺

العملة: يورو (€)
سعر الصرف: 1$ = 0.92 €
```

#### 3. Agent (الوكيل)

**اختيار العملة:**
- عند **إنشاء حساب الوكيل**، يختار **عملة العرض المفضلة** من القائمة التي أضافها المستأجر
- يستطيع **تبديل عملة العرض** في أي وقت من إعدادات الحساب
- **الرصيد الحقيقي مُخزّن بالدولار** في قاعدة البيانات (ثابت ولا يتأثر بتغيير العملة)

**العرض في الواجهة:**
- الوكيل **لا يرى الدولار نهائيًا** (إلا إذا اختار الدولار كعملة عرض)
- كل شيء يُعرض بعملته المفضلة:
  - المحفظة/الرصيد
  - أسعار المنتجات
  - تاريخ الطلبات
  - الأرباح والإحصائيات

---

### آلية التخزين والعرض:

#### في قاعدة البيانات:
```sql
-- جدول agents
balance_usd DECIMAL(18,3)          -- الرصيد الحقيقي (دائمًا بالدولار)
preferred_currency_id INT          -- مرجع للعملة المفضلة للعرض

-- جدول tenant_currencies
currency_code VARCHAR(10)          -- مثل: SAR, TRY, EUR
currency_symbol VARCHAR(5)         -- مثل: ر.س, ₺, €
display_name VARCHAR(100)          -- مثل: "ريال سعودي", "ليرة تركية"
rate_to_usd DECIMAL(18,6)          -- سعر الصرف (كم وحدة = 1$)
```

#### عند العرض للوكيل:
```python
# مثال Python
agent_balance_usd = 100.00  # المخزن في DB
currency_rate = 3.75        # سعر الصرف (ريال سعودي)

# العرض للوكيل
displayed_balance = agent_balance_usd * currency_rate
# 100 * 3.75 = 375 ر.س
```

#### عند الشراء:
```python
# الوكيل يشتري منتج بـ 50 ر.س (في واجهته)
price_in_local = 50.00
currency_rate = 3.75

# التحويل للدولار قبل الخصم
price_in_usd = price_in_local / currency_rate
# 50 / 3.75 = 13.33$

# خصم من رصيد الوكيل
agent_balance_usd -= price_in_usd
# 100 - 13.33 = 86.67$
```

---

### سيناريو كامل:

**1. المستأجر (محمد) يضيف عملات:**
- دولار: `1$ = 1.00$`
- ريال سعودي: `1$ = 3.75 ر.س`
- ليرة تركية: `1$ = 32.50 ₺`

**2. وكيل جديد (علي) يسجّل:**
- يختار عملة العرض: **ريال سعودي**
- محمد يشحن له: `100$`
- علي يرى في محفظته: `375 ر.س`

**3. علي يبيع منتج:**
- المنتج سعره: `50$` (في DB)
- علي يرى: `187.50 ر.س`
- بعد البيع، رصيده: `50$` → يرى: `187.50 ر.س`

**4. علي يسافر لتركيا:**
- يذهب للإعدادات ويغيّر العملة إلى: **ليرة تركية**
- رصيده الحقيقي: `50$` (لم يتغير)
- يرى الآن في محفظته: `1,625 ₺`

**5. محمد يغيّر سعر الصرف:**
- غيّر الريال من `3.75` إلى `4.00`
- **رصيد علي لا يتأثر:** لا يزال `50$`
- لو علي رجع للريال، سيرى: `200 ر.س` بدل `187.50 ر.س`

---

### مزايا هذه الطريقة:
✅ رصيد الوكيل **ثابت ومحمي** (لا يتأثر بتغيير أسعار الصرف)
✅ مرونة كاملة: الوكيل يستطيع تبديل العملة حسب موقعه
✅ وكيل واحد يستطيع خدمة زبائن بعملات مختلفة
✅ المستأجر يستطيع تحديث أسعار الصرف بدون التأثير على الأرصدة
✅ التخزين موحّد بالدولار = تقارير دقيقة وحسابات سهلة

---

### ملاحظات للبرمجة:

**1. عند إنشاء وكيل جديد:**
```python
# التحقق من أن العملة المختارة موجودة في قائمة المستأجر
if currency not in tenant.available_currencies:
    raise ValidationError("العملة غير مدعومة")
```

**2. عند عرض الأرقام:**
```javascript
// Frontend - عرض الرصيد
const displayBalance = (balanceUSD, currencyRate, currencySymbol) => {
  const localAmount = balanceUSD * currencyRate;
  return `${formatDecimal(localAmount)} ${currencySymbol}`;
};
```

**3. عند تغيير سعر الصرف:**
```python
# لا نحدّث أرصدة الوكلاء - فقط نحدّث سعر الصرف
tenant_currency.rate_to_usd = new_rate
tenant_currency.save()
# الأرصدة بالدولار تبقى كما هي
```

**4. Constraints في DB:**
```sql
-- كل عملة فريدة ضمن المستأجر
UNIQUE(tenant_id, currency_code)

-- سعر الصرف يجب أن يكون موجب
CHECK(rate_to_usd > 0)
```

<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->

## نظام الحد السالب (Overdraft System)

### المفهوم:
نظام **السحب على المكشوف** يسمح للوكيل بإنشاء طلبات حتى لو كان رصيده `0$`، بشرط أن يكون ضمن الحد السالب المسموح له.

---

### الحقول في قاعدة البيانات:

```sql
-- جدول agents
balance_usd DECIMAL(18,3)              -- الرصيد الحالي (قد يكون موجب أو سالب)
overdraft_limit_usd DECIMAL(18,3)     -- الحد السالب المسموح (قيمة موجبة، افتراضي: 0)
```

---

### كيف يعمل:

**القاعدة:**
```
الحد الأدنى المسموح = -(overdraft_limit_usd)
يستطيع الوكيل الشراء إذا: (balance_usd - order_price) >= -(overdraft_limit_usd)
```

**أمثلة:**

**مثال 1: وكيل بدون حد سالب**
```
balance_usd = 100.00
overdraft_limit_usd = 0.00
الحد الأدنى = -0 = 0

✅ طلب بـ 50$ → الرصيد بعده: 50$ (مسموح)
✅ طلب بـ 100$ → الرصيد بعده: 0$ (مسموح)
❌ طلب بـ 101$ → الرصيد بعده: -1$ (ممنوع!)
```

**مثال 2: وكيل مع حد سالب 1000$**
```
balance_usd = 0.00
overdraft_limit_usd = 1000.00
الحد الأدنى = -1000

✅ طلب بـ 500$ → الرصيد بعده: -500$ (مسموح)
✅ طلب بـ 1000$ → الرصيد بعده: -1000$ (مسموح)
❌ طلب بـ 1001$ → الرصيد بعده: -1001$ (ممنوع!)
```

**مثال 3: وكيل استخدم جزء من الحد**
```
balance_usd = -500.00
overdraft_limit_usd = 1000.00
الحد الأدنى = -1000
المتبقي = -500 - (-1000) = 500$

✅ طلب بـ 400$ → الرصيد بعده: -900$ (مسموح)
❌ طلب بـ 600$ → الرصيد بعده: -1100$ (ممنوع!)
```

---

### المنطق البرمجي:

**Python (Backend):**
```python
def can_create_order(agent, order_price_usd):
    """
    التحقق من قدرة الوكيل على إنشاء طلب
    """
    minimum_allowed = -agent.overdraft_limit_usd
    balance_after = agent.balance_usd - order_price_usd
    
    return balance_after >= minimum_allowed

# مثال استخدام
agent = Agent.objects.get(id=123)
order_price = 500.00

if can_create_order(agent, order_price):
    # إنشاء الطلب
    agent.balance_usd -= order_price
    agent.save()
else:
    raise ValidationError("رصيدك غير كافٍ")
```

**JavaScript (Frontend):**
```javascript
// حساب الرصيد المتاح
const getAvailableBalance = (balanceUSD, overdraftLimitUSD) => {
  return balanceUSD + overdraftLimitUSD;
};

// مثال
const agent = {
  balance_usd: -500,
  overdraft_limit_usd: 1000
};

const available = getAvailableBalance(agent.balance_usd, agent.overdraft_limit_usd);
// available = -500 + 1000 = 500$
```

---

### واجهة المستأجر (إدارة الحد السالب):

**السيناريو:**
- المستأجر يفتح صفحة تعديل وكيل **سامر**
- عملة سامر: **ليرة تركية** (سعر الصرف: 1$ = 32.5 ليرة)

**الواجهة المقترحة:**
```
┌─────────────────────────────────────────────┐
│ تعديل الوكيل: سامر أحمد                    │
├─────────────────────────────────────────────┤
│ العملة المفضلة: ليرة تركية (₺)            │
│                                             │
│ الرصيد الحالي:                              │
│ -16,250 ₺                                   │
│ (= -500 USD)                                │
│                                             │
│ الحد السالب المسموح:                        │
│ ┌──────────┐                                │
│ │ 32500    │ ₺                              │
│ └──────────┘                                │
│ = 1,000 USD                                 │
│                                             │
│ ✓ الرصيد المتاح: 16,250 ₺ (500 USD)        │
│                                             │
│ [حفظ] [إلغاء]                               │
└─────────────────────────────────────────────┘
```

**ما يحدث عند الحفظ:**
1. المستأجر يدخل: `32500` (بعملة الوكيل - ليرة)
2. النظام يحوّل: `32500 ÷ 32.5 = 1000 USD`
3. يُخزن في DB: `overdraft_limit_usd = 1000.00`

**كود التحويل:**
```python
# API Endpoint
def update_agent_overdraft(tenant, agent_id, overdraft_amount_local):
    agent = Agent.objects.get(id=agent_id, tenant=tenant)
    currency = agent.preferred_currency
    
    # تحويل من العملة المحلية للدولار
    overdraft_usd = overdraft_amount_local / currency.rate_to_usd
    
    # حفظ
    agent.overdraft_limit_usd = overdraft_usd
    agent.save()
    
    return {
        "overdraft_limit_usd": overdraft_usd,
        "overdraft_limit_local": overdraft_amount_local,
        "currency_symbol": currency.currency_symbol
    }
```

---

### واجهة الوكيل (عرض الحد السالب):

**الوكيل سامر يرى:**
```
┌─────────────────────────────────┐
│ المحفظة                         │
├─────────────────────────────────┤
│ الرصيد الحالي:                  │
│ -16,250 ₺                       │
│                                 │
│ الحد المسموح:                   │
│ 32,500 ₺                        │
│                                 │
│ الرصيد المتاح:                  │
│ 16,250 ₺                        │
│                                 │
│ ⚠️ أنت تستخدم الحد السالب       │
└─────────────────────────────────┘
```

**كل شيء بعملة الوكيل!** لا يرى الدولار نهائيًا.

---

### القيود والتحقق:

**في قاعدة البيانات:**
```sql
-- القيمة يجب أن تكون موجبة أو صفر
CHECK(overdraft_limit_usd >= 0)

-- افتراضي: لا يوجد حد سالب
DEFAULT 0.00
```

**في التطبيق:**
```python
# عند إنشاء طلب
if not can_create_order(agent, order_price):
    if agent.balance_usd < 0:
        raise ValidationError(
            f"لقد تجاوزت الحد السالب المسموح. "
            f"رصيدك المتاح: {get_available_balance(agent)}"
        )
    else:
        raise ValidationError("رصيدك غير كافٍ")
```

---

### ملاحظات مهمة:

1. **الحد السالب اختياري:**
   - افتراضيًا: `0` (لا يوجد حد سالب)
   - المستأجر يحدده لوكلاء موثوقين فقط

2. **الأمان:**
   - فقط المستأجر يستطيع تعديل الحد السالب
   - الوكيل يرى الحد لكن لا يستطيع تغييره

3. **التقارير:**
   - المستأجر يرى: "الوكلاء المدينون" (رصيد سالب)
   - تنبيهات عند اقتراب الوكيل من الحد الأقصى

4. **السداد:**
   - عند شحن رصيد للوكيل المدين، يُسدد الدين أولاً
   - مثال: رصيد `-500$` + شحن `1000$` = رصيد `500$`

---

### سيناريو كامل:

**1. المستأجر (محمد) يضع حد سالب لسامر:**
- سامر (ليرة تركية، سعر: 1$ = 32.5 ليرة)
- محمد يدخل: `32,500 ليرة` كحد سالب
- يُخزن: `1000 USD`

**2. سامر رصيده `0$`:**
- يرى: `0 ₺`
- الحد المتاح: `32,500 ₺`

**3. سامر يشتري منتج بـ `16,250 ليرة` (500$):**
- رصيده الجديد: `-500 USD`
- يرى: `-16,250 ₺`
- المتبقي: `16,250 ₺` (500$)

**4. سامر يشتري منتج بـ `16,250 ليرة` (500$):**
- رصيده الجديد: `-1000 USD`
- يرى: `-32,500 ₺`
- المتبقي: `0 ₺`

**5. سامر يحاول شراء منتج بـ `325 ليرة` (10$):**
- ❌ **ممنوع!** تجاوز الحد السالب
- رسالة: "رصيدك غير كافٍ. الرصيد المتاح: 0 ₺"

**6. محمد يشحن لسامر `16,250 ليرة` (500$):**
- رصيد سامر: `-1000 + 500 = -500 USD`
- سامر يرى: `-16,250 ₺`
- المتاح: `16,250 ₺`

---

### الأداء والتحسين:

**استخدام Redis للتحقق السريع:**
```python
# تخزين الحد في Redis للوصول السريع
redis.hset(f"agent:{agent_id}", "balance_usd", agent.balance_usd)
redis.hset(f"agent:{agent_id}", "overdraft_limit_usd", agent.overdraft_limit_usd)

# التحقق السريع
def can_create_order_fast(agent_id, order_price_usd):
    balance = float(redis.hget(f"agent:{agent_id}", "balance_usd"))
    limit = float(redis.hget(f"agent:{agent_id}", "overdraft_limit_usd"))
    
    return (balance - order_price_usd) >= -limit
```

**الفائدة:**
- التحقق من Redis أسرع 100x من DB
- مهم للطلبات الكثيرة (آلاف الطلبات/الثانية)

<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->
<!-- ------------------------------------------------- -->


